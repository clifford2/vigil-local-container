---
# SPDX-FileCopyrightText: Â© 2025 Clifford Weinmann <https://www.cliffordweinmann.com/>
# SPDX-License-Identifier: MIT-0

name: "Create and publish container image"

"on":
  push:
    # Configures this workflow to run every time a change is pushed to the branch called `main`.
    # branches: ['main']
    # Pattern matched against refs/tags
    tags:
      - "*"  # Push events to every tag not containing /
  workflow_dispatch:

# Defines custom environment variables for the workflow.
# These are used for the Container registry domain, and a name for the
# container image that this workflow builds.
env:
  REGISTRY: "ghcr.io"
  REPOBASE: "ghcr.io/${{ github.repository_owner }}"

# There is a single job in this workflow. It's configured to run on the latest available version of Ubuntu.
jobs:
  build-and-push-image:
    runs-on: "ubuntu-24.04"

    # Sets the permissions granted to the `GITHUB_TOKEN` for the actions in this job.
    permissions:
      contents: "read"
      packages: "write"
      attestations: "write"
      id-token: "write"

    steps:
      - name: "Checkout repository"
        uses: "actions/checkout@v4"

      # Uses the `docker/login-action` action to log in to the Container
      # registry using the account and password that will publish the packages.
      # Once published, the packages are scoped to the account defined here.
      - name: "Log in to the Container registry"
        uses: "docker/login-action@v3"
        with:
          registry: "${{ env.REGISTRY }}"
          username: "${{ github.actor }}"
          password: "${{ secrets.GITHUB_TOKEN }}"

      # Use a Makefile to build & push the image
      - name: "Build & push container image"
        id: "build"
        run: |
          make CONTAINER_ENGINE=docker build
          make CONTAINER_ENGINE=docker REPOBASE=${{ env.REPOBASE }} push
